#!/usr/bin/env bash
# Category: dev
# Description: Enhanced Nix REPL with useful imports and helpers
# Usage: nix-repl-advanced

set -euo pipefail

# Create temporary file with prelude
PRELUDE=$(mktemp --suffix=.nix)
trap "rm -f $PRELUDE" EXIT

# Check if we are in a flake directory, otherwise default to current dir
FLAKE_URI=${FLAKE_URI:-"path:$(pwd)"}

cat > "$PRELUDE" <<EOF
let
  pkgs = import <nixpkgs> {};
  flake = builtins.getFlake "$FLAKE_URI";
in {
  inherit pkgs flake;
  
  # Helper to print as JSON
  p = x: builtins.trace (builtins.toJSON x) x;
  
  # Helper to load a file
  l = path: import path;
  
  # Helper to search package names
  s = name: builtins.filter (p: builtins.match ".*${name}.*" p != null) (builtins.attrNames pkgs);
  
  # Short alias for lib
  lib = pkgs.lib;
}
EOF

echo "Loading Nix REPL with context from: $FLAKE_URI"
nix repl --file "$PRELUDE"