#!/usr/bin/env bash
# vm-backup - Backup VM to archive

set -euo pipefail

VM_NAME="${1:?VM name required}"
BACKUP_DIR="${2:-$HOME/Backups/VMs}"
TIMESTAMP=$(date +%Y%m%d-%H%M%S)
BACKUP_FILE="$BACKUP_DIR/${VM_NAME}-${TIMESTAMP}.tar.gz"

mkdir -p "$BACKUP_DIR"

echo "Backing up VM: $VM_NAME"
echo "Destination: $BACKUP_FILE"

# Get VM XML
virsh dumpxml "$VM_NAME" > "/tmp/${VM_NAME}.xml"

# Get disk paths
DISKS=$(virsh domblklist "$VM_NAME" | tail -n +3 | awk '{print $2}' | grep -v '^$')

# Create backup
echo "Creating backup archive..."
tar -czf "$BACKUP_FILE" \
    -C /tmp "${VM_NAME}.xml" \
    $DISKS 2>/dev/null || echo "Note: Some disks may be in use"

# Cleanup
rm "/tmp/${VM_NAME}.xml"

echo "âœ“ Backup completed: $BACKUP_FILE"
if [[ -f "$BACKUP_FILE" ]]; then
    echo "Size: $(du -h "$BACKUP_FILE" | cut -f1)"
fi
