#!/usr/bin/env bash
# Category: system
# Description: Check system health and configuration status
# Usage: check-system
# Examples:
#   check-system

set -euo pipefail

# Colors
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
CYAN='\033[0;36m'
NC='\033[0m'

print_header() {
    echo -e "${CYAN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo -e "${CYAN}  $1${NC}"
    echo -e "${CYAN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
}

print_ok() {
    echo -e "${GREEN}✓${NC} $1"
}

print_warn() {
    echo -e "${YELLOW}⚠${NC} $1"
}

print_error() {
    echo -e "${RED}✗${NC} $1"
}

print_header "System Health Check"

# Check Nix version
echo -e "\n${BLUE}Nix Version:${NC}"
nix --version

# Check generation
echo -e "\n${BLUE}Current Generation:${NC}"
nix-env --list-generations --profile /nix/var/nix/profiles/system | tail -1

# Check flake status
echo -e "\n${BLUE}Flake Status:${NC}"
FLAKE_DIR="$HOME/Projects/nix-omarchy/nix"
if [[ -d "$FLAKE_DIR" ]]; then
    cd "$FLAKE_DIR"
    if git diff --quiet 2>/dev/null; then
        print_ok "Configuration is clean (no uncommitted changes)"
    else
        print_warn "Configuration has uncommitted changes"
    fi
    
    # Check for updates
    echo -e "\n${BLUE}Checking for flake updates...${NC}"
    nix flake metadata 2>/dev/null | grep -E "Last modified:|Resolved:" || true
fi

# Check disk usage
echo -e "\n${BLUE}Disk Usage:${NC}"
df -h /nix/store | tail -1

USAGE=$(df /nix/store | tail -1 | awk '{print $5}' | sed 's/%//')
if [[ $USAGE -lt 80 ]]; then
    print_ok "Disk usage: ${USAGE}%"
elif [[ $USAGE -lt 90 ]]; then
    print_warn "Disk usage: ${USAGE}% (consider running cleanup-system)"
else
    print_error "Disk usage: ${USAGE}% (cleanup recommended!)"
fi

# Check services
echo -e "\n${BLUE}Critical Services:${NC}"
services=("NetworkManager" "bluetooth" "pipewire" "docker")
for service in "${services[@]}"; do
    if systemctl is-active --quiet "$service" 2>/dev/null; then
        print_ok "$service is running"
    else
        print_warn "$service is not running"
    fi
done

# Check failed units
echo -e "\n${BLUE}Failed Units:${NC}"
FAILED=$(systemctl list-units --failed --no-pager --no-legend | wc -l)
if [[ $FAILED -eq 0 ]]; then
    print_ok "No failed units"
else
    print_warn "$FAILED failed units found:"
    systemctl list-units --failed --no-pager
fi

# Check last boot time
echo -e "\n${BLUE}System Info:${NC}"
echo "Uptime: $(uptime -p)"
echo "Kernel: $(uname -r)"
echo "Hostname: $(hostname)"

# Check for pending updates
echo -e "\n${BLUE}Update Status:${NC}"
if [[ -d "$FLAKE_DIR" ]]; then
    cd "$FLAKE_DIR"
    BEHIND=$(git rev-list HEAD..@{u} --count 2>/dev/null || echo "0")
    if [[ $BEHIND -eq 0 ]]; then
        print_ok "Configuration is up to date with remote"
    else
        print_warn "Configuration is $BEHIND commits behind remote"
    fi
fi

echo -e "\n${GREEN}Health check complete!${NC}"
